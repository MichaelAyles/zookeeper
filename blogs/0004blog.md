# Google Auth + Cloudflare Cloud Sync

## Overview

Migrated Zookeeper from local-only storage (Dexie/IndexedDB) to a full cloud architecture using Cloudflare's edge platform. Users will authenticate via Google OAuth and have their data synced across devices.

## Architecture

**Before:** All data stored locally in IndexedDB via Dexie. No user accounts, no sync.

**After:**
- **Database**: Cloudflare D1 (SQLite at the edge)
- **Photo Storage**: Cloudflare R2 (S3-compatible)
- **API**: Cloudflare Pages Functions (file-based routing)
- **Auth**: Google OAuth 2.0 with JWT cookies

## Data Model

The key insight is separating **global** vs **private** data:

| Data | Ownership | Description |
|------|-----------|-------------|
| Zoos | Global | Shared master list, any user can add new zoos |
| Animals | Global | Tied to zoos, shared across all users |
| Visits | Private | User's zoo visits, scoped by user_id |
| Sightings | Private | User's animal sightings, scoped by user_id |

## Smart Zoo Ordering

Zoos are presented in a prioritized order:
1. **Nearby** (within 100km of user's location)
2. **Previously visited** by this user
3. **Alphabetical** for the rest

This uses the Haversine formula for geographic distance calculation.

## Files Created

### Backend (Pages Functions)
```
functions/
├── api/
│   ├── auth/
│   │   ├── google.ts      # Redirect to Google OAuth
│   │   ├── callback.ts    # Handle OAuth callback, set JWT
│   │   ├── me.ts          # Get current user
│   │   └── logout.ts      # Clear auth cookie
│   ├── zoos/
│   │   ├── index.ts       # List/create zoos
│   │   └── [id]/
│   │       ├── index.ts   # Get zoo by ID
│   │       └── animals.ts # Zoo animals CRUD
│   ├── visits/
│   │   ├── index.ts       # List/create visits
│   │   ├── [id].ts        # Update visit
│   │   └── active.ts      # Get active visit
│   ├── sightings.ts       # Sightings CRUD
│   └── stats.ts           # User statistics
├── _middleware.ts         # Auth guard for /api/*
└── lib/
    ├── auth.ts            # JWT utilities
    └── db.ts              # D1 helpers
```

### Database
```
migrations/
└── 0001_initial.sql       # Schema + seed data (15 popular zoos)
```

### Frontend Changes
- `src/lib/api.ts` - New API client with auth handling
- `src/services/*` - All migrated from Dexie to API calls
- `src/stores/useStore.ts` - User auth state instead of local profile
- `src/pages/Welcome.tsx` - Google sign-in button
- `src/App.tsx` - Auth check on mount
- Deleted `src/lib/db.ts` (Dexie no longer needed)

## Auth Flow

1. User clicks "Sign in with Google"
2. Redirect to `/api/auth/google` → Google OAuth
3. Google redirects to `/api/auth/callback`
4. Backend exchanges code for tokens, creates/updates user in D1
5. JWT set as httpOnly cookie
6. Redirect to home, `/api/auth/me` returns user data

## Pending Setup

The code is complete but requires manual Cloudflare/Google setup:

1. Create Google OAuth credentials in Cloud Console
2. Create D1 database: `npm run db:create`
3. Create R2 bucket: `wrangler r2 bucket create zookeeper-photos`
4. Set secrets: `wrangler secret put GOOGLE_CLIENT_SECRET` and `JWT_SECRET`
5. Apply migrations: `npm run db:migrate`
6. Deploy: `npm run deploy`

## Technical Notes

- JWT tokens expire after 7 days
- Auth middleware protects all `/api/*` routes except `/api/auth/*`
- Sightings use upsert logic (re-spotting same animal updates existing record)
- All dates are ISO strings (not Date objects) for JSON serialization
- No offline support - cloud-only by design
